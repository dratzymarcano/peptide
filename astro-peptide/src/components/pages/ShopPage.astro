---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import PageTitle from '../../components/PageTitle.astro';
import ProductCard from '../../components/ProductCard';
import Sidebar from '../../components/Sidebar.astro';
import { t, type SupportedLanguage, cleanProductTitle, translatePackageSize } from '../../i18n/translations';

interface Props {
  lang: SupportedLanguage;
}

const { lang } = Astro.props;

// Helper to clean slug - removes en/ lang prefix for display
const cleanSlug = (slug: string) => slug.replace(/^en\//, '');

const allProducts = await getCollection('products');
// English products are in the en/ folder
const products = allProducts.filter(p => p.slug.startsWith('en/'));

const title = t(lang, 'shopPage.title');
const subtitle = t(lang, 'shopPage.subtitle');
const showingText = t(lang, 'shopPage.showing').replace('{count}', products.length.toString());
const sortOptions = [
  t(lang, 'shopPage.sort.featured'),
  t(lang, 'shopPage.sort.priceLowHigh'),
  t(lang, 'shopPage.sort.priceHighLow'),
  t(lang, 'shopPage.sort.nameAZ'),
];
---

<Layout 
  title={title} 
  description={subtitle}
  breadcrumbs={[
    { name: t(lang, 'nav.home'), url: lang === 'en' ? '/' : `/${lang}` },
    { name: "Shop", url: lang === 'en' ? '/shop' : `/${lang}/shop` }
  ]}
>
  <PageTitle 
    title={title}
    breadcrumbs={[
      { name: t(lang, 'nav.home'), url: lang === 'en' ? '/' : `/${lang}` },
      { name: "Shop" }
    ]}
  />

  <section class="section">
    <div class="container">
      <div class="row">
        <!-- Filters Sidebar -->
        <div class="col-lg-3 mb-5">
          <Sidebar />
        </div>

        <!-- Products Grid -->
        <div class="col-lg-9">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <p class="mb-0 text-muted">{showingText}</p>
            <select class="form-control" style="width: 200px;">
              {sortOptions.map(option => <option>{option}</option>)}
            </select>
          </div>

          <div class="row product-grid">
            {products.map(product => {
              const extractPrice = (priceStr: string): number => {
                const match = priceStr?.match(/[\d,]+/);
                return match ? parseFloat(match[0].replace(',', '')) : 99;
              };
              const price = product.data.moq || extractPrice(product.data.price_range);
              const image = product.data.images && product.data.images[0] ? product.data.images[0] : '/images/peptide-default.jpg';
              const slug = cleanSlug(product.slug);
              
              return (
                <div class="col-6 col-md-6 col-lg-4 mb-4">
                  <ProductCard 
                    client:load
                    id={product.data.id}
                    title={cleanProductTitle(product.data.title, lang)}
                    price={product.data.price || price}
                    image={image}
                    slug={slug}
                    category={product.data.category}
                    purity={product.data.purity}
                    reviewCount={product.data.reviews?.length || 0}
                    packageSize={translatePackageSize(product.data.package_sizes?.[0] || '', lang)}
                    lang={lang}
                  />
                </div>
              );
            })}
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>

<style>
  /* ===== MOBILE FIRST SHOP PAGE ===== */
  
  /* Hide sidebar filters on mobile, show as collapsible or off-canvas */
  @media (max-width: 991px) {
    .col-lg-3.mb-5 {
      display: none;
    }
    
    .col-lg-9 {
      flex: 0 0 100%;
      max-width: 100%;
    }
  }

  /* Section padding */
  .section {
    padding: 24px 0 48px;
  }

  @media (min-width: 576px) {
    .section {
      padding: 32px 0 56px;
    }
  }

  @media (min-width: 992px) {
    .section {
      padding: 48px 0 80px;
    }
  }

  /* Mobile product grid spacing - tighter gaps */
  .product-grid {
    margin: 0 -6px;
  }

  .product-grid > [class*="col-"] {
    padding: 0 6px;
  }

  .product-grid .mb-4 {
    margin-bottom: 12px !important;
  }

  @media (min-width: 576px) {
    .product-grid {
      margin: 0 -10px;
    }

    .product-grid > [class*="col-"] {
      padding: 0 10px;
    }

    .product-grid .mb-4 {
      margin-bottom: 20px !important;
    }
  }

  @media (min-width: 992px) {
    .product-grid {
      margin: 0 -12px;
    }

    .product-grid > [class*="col-"] {
      padding: 0 12px;
    }

    .product-grid .mb-4 {
      margin-bottom: 24px !important;
    }
  }

  /* Mobile sort/filter bar - stacked with full-width controls */
  .d-flex.justify-content-between {
    flex-direction: column;
    gap: 12px;
    padding: 0 4px;
  }

  .d-flex.justify-content-between p {
    font-size: 13px;
    margin-bottom: 0;
  }

  .d-flex.justify-content-between select {
    width: 100% !important;
    height: 48px;
    border-radius: 10px;
    padding: 0 16px;
    font-size: 14px;
    border: 1px solid #e5e7eb;
    background: white;
    -webkit-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 14px center;
  }

  @media (min-width: 576px) {
    .d-flex.justify-content-between {
      flex-direction: row;
      gap: 0;
      align-items: center;
      padding: 0;
    }

    .d-flex.justify-content-between p {
      font-size: 14px;
    }

    .d-flex.justify-content-between select {
      width: 200px !important;
      height: 44px;
    }
  }

  /* Container padding on mobile */
  .container {
    padding-left: 16px;
    padding-right: 16px;
  }

  @media (min-width: 576px) {
    .container {
      padding-left: 20px;
      padding-right: 20px;
    }
  }

  @media (min-width: 768px) {
    .container {
      padding-left: 15px;
      padding-right: 15px;
    }
  }
</style>
