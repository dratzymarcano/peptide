---
import Layout from '../../layouts/Layout.astro';
import PageTitle from '../../components/PageTitle.astro';
import { t, getLocalizedPath, getLocalizedProductSlug, type SupportedLanguage } from '../../i18n/translations';
import { getCollection } from 'astro:content';

interface Props {
  lang: SupportedLanguage;
}

const { lang } = Astro.props;

// Get all products (use English as base, fall back to localized content if available)
const allProducts = await getCollection('products');
const englishProducts = allProducts.filter(p => p.slug.startsWith('en/'));
const products = englishProducts
  .map((product) => {
    const baseSlug = product.slug.replace('en/', '');
    const localized = allProducts.find(p => p.slug === `${lang}/${baseSlug}`);
    return localized || product;
  })
  .sort((a, b) => a.data.title.localeCompare(b.data.title));

// Get all blog posts
const allBlogPosts = await getCollection('blog');
const blogPosts = allBlogPosts
  .sort((a, b) => new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime())
  .slice(0, 10); // Limit to 10 most recent

// Section titles per language
const sectionTitles = {
  en: { main: 'Main Pages', products: 'Products', categories: 'Product Categories', blog: 'Recent Blog Posts', legal: 'Legal & Policies' },
  nl: { main: 'Hoofdpagina\'s', products: 'Producten', categories: 'Productcategorieën', blog: 'Recente Blogberichten', legal: 'Juridisch & Beleid' },
  de: { main: 'Hauptseiten', products: 'Produkte', categories: 'Produktkategorien', blog: 'Neueste Blogbeiträge', legal: 'Rechtliches & Richtlinien' },
  fr: { main: 'Pages Principales', products: 'Produits', categories: 'Catégories de Produits', blog: 'Articles de Blog Récents', legal: 'Mentions Légales' },
  es: { main: 'Páginas Principales', products: 'Productos', categories: 'Categorías de Productos', blog: 'Artículos de Blog Recientes', legal: 'Legal y Políticas' },
  it: { main: 'Pagine Principali', products: 'Prodotti', categories: 'Categorie di Prodotti', blog: 'Articoli del Blog Recenti', legal: 'Legale e Politiche' },
};

const titles = sectionTitles[lang];

// Main pages
const mainPages = [
  { name: t(lang, 'nav.home'), url: getLocalizedPath('/', lang) },
  { name: t(lang, 'nav.about'), url: getLocalizedPath('/about/', lang) },
  { name: t(lang, 'shopPage.title'), url: getLocalizedPath('/shop/', lang) },
  { name: t(lang, 'nav.quality'), url: getLocalizedPath('/quality/', lang) },
  { name: t(lang, 'nav.contact'), url: getLocalizedPath('/contact/', lang) },
  { name: t(lang, 'faqPage.title'), url: getLocalizedPath('/faq/', lang) },
  { name: t(lang, 'cart.shipping'), url: getLocalizedPath('/shipping/', lang) },
  { name: t(lang, 'bundlesPage.title'), url: getLocalizedPath('/bundles/', lang) },
];

// Product categories
const categories = [
  { name: t(lang, 'nav.allPeptides'), url: getLocalizedPath('/peptides/', lang) },
  { name: t(lang, 'nav.weightLoss'), url: getLocalizedPath('/peptides/weight-loss/', lang) },
  { name: t(lang, 'nav.muscleRecovery'), url: getLocalizedPath('/peptides/muscle-recovery/', lang) },
  { name: t(lang, 'nav.growthHormone'), url: getLocalizedPath('/peptides/growth-hormone/', lang) },
  { name: t(lang, 'nav.tanning'), url: getLocalizedPath('/peptides/tanning/', lang) },
  { name: t(lang, 'nav.cognitive'), url: getLocalizedPath('/peptides/cognitive/', lang) },
  { name: t(lang, 'nav.supplies'), url: getLocalizedPath('/peptides/supplies/', lang) },
];

// Legal pages
const legalPages = [
  { name: t(lang, 'footer.termsAndConditions'), url: getLocalizedPath('/terms/', lang) },
  { name: t(lang, 'footer.privacyPolicy'), url: getLocalizedPath('/privacy/', lang) },
  { name: t(lang, 'footer.disclaimer'), url: getLocalizedPath('/disclaimer/', lang) },
  { name: t(lang, 'footer.coaPolicy'), url: getLocalizedPath('/coa-policy/', lang) },
];

const breadcrumbs = [
  { name: t(lang, 'nav.home'), url: getLocalizedPath('/', lang) },
  { name: t(lang, 'footer.sitemap'), url: getLocalizedPath('/sitemap/', lang) }
];

const pageTitle = t(lang, 'footer.sitemap');
const pageDescription = lang === 'en' ? 'Complete site map of Peptide Shop. Navigate to all pages, products, categories, and resources.' :
  lang === 'nl' ? 'Volledige sitemap van Peptide Shop. Navigeer naar alle pagina\'s, producten, categorieën en bronnen.' :
  lang === 'de' ? 'Vollständige Seitenübersicht von Peptide Shop. Navigieren Sie zu allen Seiten, Produkten, Kategorien und Ressourcen.' :
  lang === 'fr' ? 'Plan du site complet de Peptide Shop. Accédez à toutes les pages, produits, catégories et ressources.' :
  lang === 'es' ? 'Mapa del sitio completo de Peptide Shop. Navegue a todas las páginas, productos, categorías y recursos.' :
  'Mappa del sito completa di Peptide Shop. Naviga verso tutte le pagine, prodotti, categorie e risorse.';
---

<Layout 
  title={`${pageTitle} | Peptide Shop`}
  description={pageDescription}
  breadcrumbs={breadcrumbs}
>
  <PageTitle 
    title={pageTitle}
    subtitle={pageDescription}
    breadcrumbs={breadcrumbs}
  />

  <section class="section">
    <div class="container">
      <div class="row">
        <!-- Main Pages -->
        <div class="col-lg-4 col-md-6 mb-4">
          <div class="sitemap-section">
            <h2 class="sitemap-heading">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
              </svg>
              {titles.main}
            </h2>
            <ul class="sitemap-list">
              {mainPages.map(page => (
                <li><a href={page.url}>{page.name}</a></li>
              ))}
            </ul>
          </div>
        </div>

        <!-- Product Categories -->
        <div class="col-lg-4 col-md-6 mb-4">
          <div class="sitemap-section">
            <h2 class="sitemap-heading">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"></path>
              </svg>
              {titles.categories}
            </h2>
            <ul class="sitemap-list">
              {categories.map(cat => (
                <li><a href={cat.url}>{cat.name}</a></li>
              ))}
            </ul>
          </div>
        </div>

        <!-- Legal Pages -->
        <div class="col-lg-4 col-md-6 mb-4">
          <div class="sitemap-section">
            <h2 class="sitemap-heading">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
              </svg>
              {titles.legal}
            </h2>
            <ul class="sitemap-list">
              {legalPages.map(page => (
                <li><a href={page.url}>{page.name}</a></li>
              ))}
            </ul>
          </div>
        </div>
      </div>

      <!-- Products Section -->
      <div class="row mt-4">
        <div class="col-12">
          <div class="sitemap-section">
            <h2 class="sitemap-heading">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"></path>
                <path d="M2 12h20"></path>
              </svg>
              {titles.products} ({products.length})
            </h2>
            <div class="row">
              {products.map(product => {
                const productSlug = product.slug.replace(/^(en|nl|de|fr|es|it)\//, '');
                const urlPath = product.data.urlPath || `/peptides/${getLocalizedProductSlug(productSlug, lang)}/`;
                const localizedUrl = lang === 'en' ? urlPath : `/${lang}${urlPath.startsWith('/') ? '' : '/'}${urlPath}`;
                return (
                  <div class="col-lg-3 col-md-4 col-6 mb-2">
                    <a href={localizedUrl} class="product-link">{product.data.title.split('|')[0].trim()}</a>
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      </div>

      {blogPosts.length > 0 && (
        <div class="row mt-4">
          <div class="col-12">
            <div class="sitemap-section">
              <h2 class="sitemap-heading">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                  <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                </svg>
                {titles.blog}
              </h2>
              <ul class="sitemap-list sitemap-list--blog">
                {blogPosts.map(post => (
                  <li>
                    <a href={getLocalizedPath(`/blog/${post.slug.replace(/^(en|nl|de|fr|es|it)\//, '')}/`, lang)}>
                      {post.data.title}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          </div>
        </div>
      )}
    </div>
  </section>
</Layout>

<style>
  .sitemap-section {
    background: var(--card-bg, #fff);
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    height: 100%;
  }

  .sitemap-heading {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--heading-color, #023047);
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 2px solid var(--accent-color, #0096c7);
  }

  .sitemap-heading svg {
    color: var(--accent-color, #0096c7);
    flex-shrink: 0;
  }

  .sitemap-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .sitemap-list li {
    padding: 8px 0;
    border-bottom: 1px solid var(--border-color, #e5e7eb);
  }

  .sitemap-list li:last-child {
    border-bottom: none;
  }

  .sitemap-list a {
    color: var(--text-color, #374151);
    text-decoration: none;
    transition: color 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .sitemap-list a:hover {
    color: var(--accent-color, #0096c7);
  }

  .sitemap-list a::before {
    content: '→';
    color: var(--accent-color, #0096c7);
    font-size: 0.875rem;
  }

  .product-link {
    display: block;
    color: var(--text-color, #374151);
    text-decoration: none;
    padding: 6px 0;
    font-size: 0.9rem;
    transition: color 0.2s ease;
  }

  .product-link:hover {
    color: var(--accent-color, #0096c7);
  }

  .sitemap-list--blog {
    columns: 2;
    column-gap: 32px;
  }

  @media (max-width: 768px) {
    .sitemap-list--blog {
      columns: 1;
    }
  }

  :global([data-theme="dark"]) .sitemap-section {
    background: var(--card-bg, #1e293b);
  }

  :global([data-theme="dark"]) .sitemap-heading {
    color: #e2e8f0;
  }

  :global([data-theme="dark"]) .sitemap-list a,
  :global([data-theme="dark"]) .product-link {
    color: #cbd5e1;
  }
</style>
