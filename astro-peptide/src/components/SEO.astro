---
interface Props {
	title: string;
	description?: string;
	image?: string;
	article?: boolean;
	lang?: string;
	schema?: object;
	publishedTime?: string;
	modifiedTime?: string;
	author?: string;
	availableLangs?: SupportedLanguage[];
}

const { title, description, image, article, schema, publishedTime, modifiedTime, author, availableLangs } = Astro.props;
import { getLangFromUrl, supportedLanguages, type SupportedLanguage, getLocalizedPath } from '../i18n/translations';
import { getMarket } from '../i18n/market';

const currentLang = getLangFromUrl(Astro.url);

// Allow explicit override, but default to URL language.
const langProp = (Astro.props.lang ?? currentLang) as SupportedLanguage;
const langForMeta = supportedLanguages.includes(langProp) ? langProp : currentLang;
const marketForMeta = getMarket(langForMeta);

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const siteUrl = Astro.site?.origin || 'https://peptide-shop.net';

const normalizeWhitespace = (value: string) => value.replace(/\s+/g, ' ').trim();

const clampText = (value: string, min: number, max: number, suffix: string) => {
	let text = normalizeWhitespace(value || '');
	if (!text) return '';
	if (text.length < min) {
		const withSuffix = normalizeWhitespace(`${text} ${suffix}`);
		text = withSuffix.length <= max ? withSuffix : withSuffix.slice(0, max - 1).trimEnd() + '…';
	}
	if (text.length > max) {
		text = text.slice(0, max - 1).trimEnd() + '…';
	}
	return text;
};

// Default title/description if none provided - optimized for local SEO
const fallbackTitle = `${marketForMeta.primaryKeywords[0]} | Peptide Shop`;
const baseTitle = normalizeWhitespace(title || fallbackTitle);
const metaTitle = clampText(baseTitle, 25, 60, 'Peptide Shop');

const defaultDescription = `${marketForMeta.primaryKeywords[0]} - Premium research peptides with 99% HPLC purity. Fast ${marketForMeta.countryName} delivery, COA included. Semaglutide, BPC-157, Tirzepatide & more.`;
const baseDescription = normalizeWhitespace(description || defaultDescription);
const metaDescription = clampText(baseDescription, 90, 160, `Shop trusted research peptides in ${marketForMeta.countryName}.`);

// Default image
const ogImage = image || '/images/hero-image.webp';

// Supported languages for hreflang
const languages = (availableLangs && availableLangs.length > 0)
	? Array.from(new Set(availableLangs))
	: supportedLanguages;
const xDefaultLang = languages.includes('en') ? 'en' : (languages[0] ?? langForMeta);
const currentPath = Astro.url.pathname;
const xDefaultHref = `${siteUrl}${getLocalizedPath(currentPath, xDefaultLang)}`;

// Build comprehensive keywords for SEO/AEO/GEO
const allKeywords = [
  ...marketForMeta.primaryKeywords,
  ...marketForMeta.secondaryKeywords.slice(0, 3),
  ...marketForMeta.productKeywords.slice(0, 3)
];
const keywords = allKeywords.join(', ');

// Current date for freshness signals
const currentDate = new Date().toISOString();
---

<!-- Global Metadata -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" type="image/png" href="/favicon.png" />
<link rel="apple-touch-icon" href="/favicon.png" />
<meta name="generator" content={Astro.generator} />
<meta name="theme-color" content="#0077b6" />
{keywords && <meta name="keywords" content={keywords} />}

<!-- Canonical URL -->
<link rel="canonical" href={canonicalURL} />

<!-- Hreflang Tags for Internationalization - Critical for GEO/Local SEO -->
<link rel="alternate" hreflang="x-default" href={xDefaultHref} />
{languages.map((langCode) => {
	const hreflang = getMarket(langCode).hreflang;
	const href = `${siteUrl}${getLocalizedPath(currentPath, langCode)}`;
	return <link rel="alternate" hreflang={hreflang} href={href} />;
})}

<!-- Primary Meta Tags - AEO Optimized -->
<title>{metaTitle}</title>
<meta name="title" content={metaTitle} />
<meta name="description" content={metaDescription} />
<meta name="author" content={author || "Peptide Shop"} />

<!-- Geo Meta Tags for Local SEO -->
<meta name="geo.region" content={marketForMeta.geoRegion} />
<meta name="geo.placename" content={marketForMeta.geoPlacename} />
{marketForMeta.icbm && <meta name="ICBM" content={marketForMeta.icbm} />}
<meta name="DC.language" content={marketForMeta.hreflang} />
<meta name="content-language" content={marketForMeta.hreflang} />

<!-- Open Graph / Facebook -->
<meta property="og:type" content={article ? 'article' : 'website'} />
<meta property="og:url" content={Astro.url} />
<meta property="og:title" content={title} />
<meta property="og:description" content={metaDescription} />
<meta property="og:image" content={new URL(ogImage, siteUrl)} />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:site_name" content="Peptide Shop" />
<meta property="og:locale" content={marketForMeta.hreflang.replace('-', '_')} />
{languages.filter(l => l !== langForMeta).map((langCode) => {
	const hreflang = getMarket(langCode).hreflang;
	return <meta property="og:locale:alternate" content={hreflang.replace('-', '_')} />;
})}

<!-- Article specific Open Graph tags -->
{article && publishedTime && <meta property="article:published_time" content={publishedTime} />}
{article && modifiedTime && <meta property="article:modified_time" content={modifiedTime} />}
{article && <meta property="article:author" content={author || "Peptide Shop"} />}
{article && <meta property="article:section" content="Research Peptides" />}

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content={Astro.url} />
<meta property="twitter:title" content={title} />
<meta property="twitter:description" content={metaDescription} />
<meta property="twitter:image" content={new URL(ogImage, siteUrl)} />
<meta name="twitter:creator" content="@peptideshop" />
<meta name="twitter:site" content="@peptideshop" />

<!-- Robots - Enhanced for AI crawlers -->
<meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />
<meta name="googlebot" content="index, follow" />
<meta name="bingbot" content="index, follow" />

<!-- AI/LLM Crawler Hints for AEO/GEO -->
<meta name="ai.summary" content={metaDescription} />
<meta name="format-detection" content="telephone=no" />

<!-- Preconnect for performance -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

{schema && <script is:inline type="application/ld+json" set:html={JSON.stringify(schema)} />}
