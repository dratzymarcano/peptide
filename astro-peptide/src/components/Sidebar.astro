---
import { getCollection } from 'astro:content';
import { t, type SupportedLanguage, getLocalizedPath, translateCategorySlug } from '../i18n/translations';

interface Props {
  activeCategory?: string;
  showProductInfo?: boolean;
  productInfo?: {
    cas?: string;
    purity?: string;
    rating?: number;
    reviewCount?: number;
  };
  lang?: SupportedLanguage;
}

const { activeCategory, showProductInfo = false, productInfo, lang = 'en' } = Astro.props;

// Get all products and calculate category counts
const allProducts = await getCollection('products');
// Filter to English products only for counts/listings to avoid duplicates
const products = allProducts.filter(p => p.slug.startsWith('en/'));
const categories = [...new Set(products.map((product) => product.data.category))];

// Map category to translation key
const getCategoryKey = (cat: string) => {
  const map: Record<string, string> = {
    'weight-loss': 'weightLoss',
    'muscle-recovery': 'muscleRecovery',
    'growth-hormone': 'growthHormone',
    'tanning': 'tanning',
    'cognitive': 'cognitive',
    'supplies': 'supplies'
  };
  return map[cat] || cat;
};

// Helper to get category URL with translated slug
const getCategoryUrl = (category: string) => {
  if (lang === 'en') {
    return `/peptides/${category}/`;
  }
  const translatedSlug = translateCategorySlug(category, lang);
  return `/${lang}/peptides/${translatedSlug}/`;
};

const productCount = products.length;
---

<aside class="sidebar">
  <div class="sidebar-widget">
    <h3 class="sidebar-title">{t(lang, 'nav.categories')}</h3>
    <ul class="category-list">
      <li>
        <a href={getLocalizedPath('/peptides', lang)} class:list={[["category-link", { active: !activeCategory }]]}>
          {t(lang, 'nav.allPeptides')} <span class="count">({productCount})</span>
        </a>
      </li>
      {categories.map(cat => {
        const catProducts = products.filter(p => p.data.category === cat);
        const isActive = activeCategory === cat;
        const title = t(lang, `nav.${getCategoryKey(cat)}` as any) || cat.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        return (
          <li>
            <a href={getCategoryUrl(cat)} class:list={[["category-link", { active: isActive }]]}>
              {title}
              <span class="count">({catProducts.length})</span>
            </a>
          </li>
        );
      })}
    </ul>
  </div>

  <div class="sidebar-widget why-us">
    <h4 class="sidebar-title">{t(lang, 'home.about.title')}</h4>
    <ul class="why-list">
      <li>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#0077b6" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
        {t(lang, 'product.trust.purity')}
      </li>
      <li>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#0077b6" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
        {t(lang, 'product.trust.coa')}
      </li>
      <li>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#0077b6" stroke-width="2"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>
        {t(lang, 'product.trust.delivery')}
      </li>
    </ul>
  </div>

  {showProductInfo && productInfo && (
    <div class="sidebar-widget product-info">
      <h5 class="sidebar-title">{t(lang, 'product.specifications')}</h5>
      <ul class="info-list">
        {productInfo.cas && (
          <li>
            <span class="label">{t(lang, 'product.casNo')}</span>
            <span class="value">{productInfo.cas}</span>
          </li>
        )}
        {productInfo.purity && (
          <li>
            <span class="label">{t(lang, 'product.purity')}</span>
            <span class="value purity">{productInfo.purity}</span>
          </li>
        )}
        {productInfo.rating !== undefined && (
          <li>
            <span class="label">{t(lang, 'product.reviews')}</span>
            <span class="value">
              <span class="star">â˜…</span> {productInfo.rating.toFixed(1)} ({productInfo.reviewCount || 0})
            </span>
          </li>
        )}
        <li>
          <span class="label">{t(lang, 'product.inStock')}</span>
          <span class="value stock">{t(lang, 'product.inStock')}</span>
        </li>
      </ul>
    </div>
  )}
</aside>

<style>
  .sidebar {
    width: 280px;
    flex-shrink: 0;
  }

  .sidebar-widget {
    background: white;
    border-radius: 12px;
    padding: 24px;
    border: 1px solid #e2e8f0;
    margin-bottom: 24px;
  }

  .sidebar-title {
    font-size: 1rem;
    font-weight: 700;
    color: #0f172a;
    margin-bottom: 16px;
  }

  .category-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .category-list li {
    margin-bottom: 8px;
  }

  .category-link {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    border-radius: 8px;
    color: #475569;
    text-decoration: none;
    font-size: 14px;
    transition: all 0.2s;
  }

  .category-link:hover {
    background: #f1f5f9;
    color: #0077b6;
  }

  .category-link.active {
    background: #0077b6;
    color: white;
    font-weight: 600;
  }

  .category-link .count {
    font-size: 12px;
    opacity: 0.7;
  }

  .why-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .why-list li {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    font-size: 14px;
    color: #475569;
  }

  .info-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .info-list li {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid #f1f5f9;
    font-size: 14px;
  }

  .info-list li:last-child {
    border-bottom: none;
  }

  .info-list .label {
    color: #64748b;
  }

  .info-list .value {
    font-weight: 600;
    color: #1e293b;
  }

  .info-list .value.purity {
    color: #10b981;
  }

  .info-list .value.stock {
    color: #10b981;
  }

  .info-list .star {
    color: #f5a623;
  }

  /* Responsive */
  @media (max-width: 991px) {
    .sidebar {
      width: 100%;
      margin-bottom: 24px;
    }

    .sidebar-widget {
      padding: 20px;
    }
  }

  @media (max-width: 767px) {
    .sidebar {
      display: none;
    }
  }
</style>
