---
import { getCollection } from 'astro:content';
import ProductCard from './ProductCard';
import { t, type SupportedLanguage, getLocalizedPath, cleanProductTitle, translatePackageSize } from '../i18n/translations';

interface Props {
  currentSlug: string;
  category: string;
  limit?: number;
  lang: SupportedLanguage;
}

const { currentSlug, category, limit = 4, lang } = Astro.props;

// Helper to clean slug
const cleanSlug = (slug: string) => slug.replace(/^\/peptides\//, '').replace(/^\//, '');

// Get all products
const collection = await getCollection('products');
// Filter to English products to ensure unique recommendations
const allProducts = collection.filter(p => p.slug.startsWith('en/'));

// Filter related products (same category, exclude current)
const relatedProducts = allProducts
  .filter(p => p.data.category === category && cleanSlug(p.slug) !== currentSlug)
  .slice(0, limit);

// If not enough in same category, add from other categories
const otherProducts = relatedProducts.length < limit 
  ? allProducts
      .filter(p => cleanSlug(p.slug) !== currentSlug && !relatedProducts.includes(p))
      .slice(0, limit - relatedProducts.length)
  : [];

const displayProducts = [...relatedProducts, ...otherProducts];
---

{displayProducts.length > 0 && (
  <section class="related-products mt-5 pt-5 border-top">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3 class="mb-0 d-flex align-items-center">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-2" style="color: #0077b6;">
          <rect x="3" y="3" width="7" height="7"></rect>
          <rect x="14" y="3" width="7" height="7"></rect>
          <rect x="14" y="14" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect>
        </svg>
        {t(lang, 'product.relatedProducts')}
      </h3>
      <a href={getLocalizedPath('/peptides/', lang)} class="btn btn-sm btn-outline-primary">
        {t(lang, 'home.bestSellers.viewAllPeptides')}
      </a>
    </div>
    
    <div class="row">
      {displayProducts.map((product) => {
        const price = product.data.price || product.data.moq || 45;
        const image = product.data.images[0] || '/images/peptide-default.jpg';
        const slug = cleanSlug(product.slug);
        
        return (
          <div class="col-lg-3 col-md-6 mb-4">
            <ProductCard 
              client:visible
              id={product.data.id}
              title={cleanProductTitle(product.data.title.split('|')[0].trim(), lang)}
              slug={slug}
              price={price}
              category={product.data.category}
              image={image}
              purity={product.data.purity}
              packageSize={translatePackageSize(product.data.package_sizes?.[0] || '', lang)}
              lang={lang}
            />
          </div>
        );
      })}
    </div>
  </section>
)}
