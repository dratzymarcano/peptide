---
import Layout from '../../../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { t, getLocalizedPath, type SupportedLanguage } from '../../../../i18n/translations';

export const prerender = true;

const normalizeCategory = (value: string) => value.toLowerCase().trim().replace(/\s+/g, '-');

// Helper function to strip language prefix from blog slugs
function stripLangPrefix(slug: string): string {
  return slug
    .replace(/^(en|nl|de|fr|es|it|ru)\//, '')
    .replace(/^(nl|de|fr|es|it|ru)-/, '');
}

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const categories = Array.from(
    new Set(posts.map((p) => p.data.category).filter(Boolean) as string[])
  );
  const languages: SupportedLanguage[] = ['nl', 'de', 'fr', 'es', 'it', 'ru'];

  return languages.flatMap((lang) =>
    categories.map((category) => {
      const categorySlug = category.toLowerCase().trim().replace(/\s+/g, '-');
      return {
        params: { lang, category: categorySlug },
        props: { lang, category, posts },
      };
    })
  );
}

const { lang, category, posts } = Astro.props;
const categorySlug = normalizeCategory(category);

// Filter posts by category AND language, with fallback to English
const localizedPosts = posts
  .filter((p) => normalizeCategory(p.data.category || '') === categorySlug && p.data.lang === lang)
  .sort((a, b) => new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime());

const englishPosts = posts
  .filter((p) => normalizeCategory(p.data.category || '') === categorySlug && (p.data.lang === 'en' || !p.data.lang))
  .sort((a, b) => new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime());

// Use localized posts if available, otherwise use English posts with English paths
const filtered = localizedPosts.length > 0 
  ? localizedPosts.map(p => ({ ...p, useFallbackLang: false }))
  : englishPosts.map(p => ({ ...p, useFallbackLang: true }));
---

<Layout
  title={`${category} | ${t(lang, 'blogPage.title')} | Peptide Shop`}
  description={`${t(lang, 'blogPage.categories')}: ${category}`}
  breadcrumbs={[
    { name: t(lang, 'common.home'), url: getLocalizedPath('/', lang) },
    { name: t(lang, 'blogPage.title'), url: getLocalizedPath('/blog/', lang) },
    { name: category, url: getLocalizedPath(`/blog/category/${categorySlug}/`, lang) }
  ]}
>
  <section style="padding: 60px 0; background: white;">
    <div class="container">
      <h1 style="font-weight: 800; font-size: 2rem; margin-bottom: 12px;">{category}</h1>
      <p style="color: #64748b; margin-bottom: 28px;">{t(lang, 'blogPage.articleCount').replace('{count}', filtered.length.toString())}</p>

      <div class="row g-4">
        {filtered.map((post) => {
          // Use English path for fallback posts, localized path for native language posts
          const postSlug = stripLangPrefix(post.slug);
          const blogPath = post.useFallbackLang 
            ? `/blog/${postSlug}/` 
            : getLocalizedPath(`/blog/${postSlug}/`, lang);
          return (
            <div class="col-md-6 col-lg-4">
              <a href={blogPath} style="display:block; text-decoration:none;">
                <div style="border: 1px solid rgba(148,163,184,0.25); border-radius: 14px; overflow: hidden; background: white; height: 100%;">
                  {post.data.image && (
                    <img src={post.data.image} alt={post.data.title} style="width: 100%; height: 180px; object-fit: cover;" />
                  )}
                  <div style="padding: 18px;">
                    <div style="font-size: 12px; color: #64748b; margin-bottom: 8px;">{post.data.publishDate}</div>
                    <div style="font-weight: 800; color: #0f172a; line-height: 1.25;">{post.data.title}</div>
                    <div style="margin-top: 10px; color: #64748b; line-height: 1.6;">{post.data.description}</div>
                  </div>
                </div>
              </a>
            </div>
          );
        })}
      </div>

      <div style="margin-top: 28px;">
        <a href={getLocalizedPath('/blog/', lang)} style="color: #0077b6; font-weight: 700; text-decoration: none;">{t(lang, 'blogPage.backToBlog')}</a>
      </div>
    </div>
  </section>
</Layout>