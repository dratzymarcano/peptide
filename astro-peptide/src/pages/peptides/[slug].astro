---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import PageTitle from '../../components/PageTitle.astro';
import ProductOptions from '../../components/ProductOptions';
import { t } from '../../i18n/translations';
import { toOptimizedImage } from '../../utils/images';

const lang = 'en';
import ProductFAQs from '../../components/ProductFAQs.astro';
import ProductReviews from '../../components/ProductReviews.astro';
import RelatedProducts from '../../components/RelatedProducts.astro';
import Sidebar from '../../components/Sidebar.astro';

export const prerender = true;

export async function getStaticPaths() {
  const allProducts = await getCollection('products');
  
  // English products are in the en/ folder
  const products = allProducts.filter(p => p.slug.startsWith('en/'));
  
  return products.map(product => {
    // Remove the "en/" prefix to get the base slug
    const slug = product.slug.replace(/^en\//, '');
    return {
      params: { slug },
      props: { product },
    };
  });
}

// Helper to clean slug - removes en/ prefix, /peptides/ prefix and leading slashes
const cleanSlug = (slug: string) => slug.replace(/^en\//, '').replace(/^\/peptides\//, '').replace(/^\//, '');

const { product } = Astro.props;
const { Content } = await product.render();

const priceRange = product.data.price_range;
const productId = product.data.id;
const productTitle = product.data.title;
const currentSlug = cleanSlug(product.slug);
const productImage = toOptimizedImage(product.data.images && product.data.images[0] ? product.data.images[0] : '/images/peptide-default.jpg');

// Extract numeric price from price_range
const extractPrice = (priceStr: string): number => {
  const match = priceStr?.match(/[\d,]+/);
  return match ? parseFloat(match[0].replace(',', '')) : 99;
};
const productPrice = product.data.moq || extractPrice(priceRange);

// Get FAQs and Reviews from frontmatter
const faqs = product.data.faqs || [];
const reviews = product.data.reviews || [];

// Calculate average rating
const avgRating = reviews.length > 0 
  ? (reviews.reduce((sum: number, r: any) => sum + r.rating, 0) / reviews.length).toFixed(1)
  : '5.0';

// Site URL for structured data
const siteUrl = import.meta.env.SITE || 'https://peptide-shop.net';
const productUrl = `${siteUrl}/peptides/${currentSlug}/`;
const productImageUrl = productImage.startsWith('http') ? productImage : `${siteUrl}${productImage}`;

// Product structured data for SEO with enhanced geo-targeting
const productSchema = {
  "@context": "https://schema.org",
  "@type": "Product",
  "name": product.data.title.split('|')[0].trim().replace('Buy ', '').replace(' UK', ''),
  "description": product.data.meta.description,
  "image": productImageUrl,
  "sku": productId,
  "mpn": product.data.cas || productId,
  "brand": {
    "@type": "Brand",
    "name": "Peptide Shop"
  },
  "manufacturer": {
    "@type": "Organization",
    "name": "Peptide Shop",
    "url": siteUrl
  },
  "category": product.data.category.replace(/-/g, ' ').replace(/\b\w/g, (l: string) => l.toUpperCase()) + " Peptides",
  "offers": {
    "@type": "Offer",
    "url": productUrl,
    "priceCurrency": "GBP",
    "price": productPrice,
    "availability": "https://schema.org/InStock",
    "priceValidUntil": new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toISOString().split('T')[0],
    "itemCondition": "https://schema.org/NewCondition",
    "shippingDetails": {
      "@type": "OfferShippingDetails",
      "shippingDestination": [
        {"@type": "DefinedRegion", "addressCountry": "GB"},
        {"@type": "DefinedRegion", "addressCountry": "NL"},
        {"@type": "DefinedRegion", "addressCountry": "DE"},
        {"@type": "DefinedRegion", "addressCountry": "FR"},
        {"@type": "DefinedRegion", "addressCountry": "ES"},
        {"@type": "DefinedRegion", "addressCountry": "IT"}
      ],
      "deliveryTime": {
        "@type": "ShippingDeliveryTime",
        "handlingTime": {"@type": "QuantitativeValue", "minValue": 0, "maxValue": 1, "unitCode": "DAY"},
        "transitTime": {"@type": "QuantitativeValue", "minValue": 1, "maxValue": 5, "unitCode": "DAY"}
      }
    },
    "seller": {
      "@type": "Organization",
      "name": "Peptide Shop"
    }
  },
  ...(reviews.length > 0 && {
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": avgRating,
      "reviewCount": reviews.length,
      "bestRating": "5",
      "worstRating": "1"
    }
  })
};

// FAQ Schema for Answer Engine Optimization (AEO)
const faqSchema = faqs.length > 0 ? {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": faqs.map((faq: any) => ({
    "@type": "Question",
    "name": faq.question,
    "acceptedAnswer": {
      "@type": "Answer",
      "text": faq.answer
    }
  }))
} : null;
---

<Layout 
  title={product.data.meta.title} 
  description={product.data.meta.description}
  image={productImage}
  article={true}
  breadcrumbs={[
    { name: "Home", url: "/" },
    { name: "Peptides", url: "/peptides" },
    { name: product.data.category.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()), url: `/peptides/${product.data.category}` },
    { name: product.data.title.split('|')[0].trim().replace('Buy ', '').replace(' UK', ''), url: `/peptides/${currentSlug}/` }
  ]}
>
  <!-- Product Schema JSON-LD -->
  <script is:inline type="application/ld+json" set:html={JSON.stringify(productSchema)} />
  
  <!-- FAQ Schema for AEO -->
  {faqSchema && <script is:inline type="application/ld+json" set:html={JSON.stringify(faqSchema)} />}
  
  <PageTitle 
    title={product.data.title.split('|')[0].trim()}
    subtitle={product.data.short_description}
    breadcrumbs={[
      { name: "Home", url: "/" },
      { name: "Peptides", url: "/peptides" },
      { name: product.data.category.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()), url: `/peptides/${product.data.category}` },
      { name: product.data.title.split('|')[0].trim().replace('Buy ', '').replace(' UK', ''), url: `/peptides/${currentSlug}/` }
    ]}
  />

  <section class="section course">
    <div class="container">
      <div class="row">
        <!-- Left Sidebar -->
        <div class="col-lg-3 col-md-4 d-none d-md-block">
          <div class="sticky-top" style="top: 100px;">
            <Sidebar 
              activeCategory={product.data.category} 
              showProductInfo={true}
              productInfo={{
                cas: product.data.cas || undefined,
                purity: product.data.purity || undefined,
                rating: parseFloat(avgRating),
                reviewCount: reviews.length
              }}
            />
          </div>
        </div>
        
        <!-- Main Content with Tabs -->
        <div class="col-lg-5 col-md-8">
          <div class="single-course">
            <!-- Product Image -->
            {product.data.images && product.data.images[0] && (
              <div class="product-image-container mb-4 text-center bg-white p-4 rounded shadow-sm">
                <img src={productImage} alt={productTitle} class="img-fluid rounded" style="max-height: 350px; object-fit: contain;" />
              </div>
            )}

            <!-- Tabbed Content -->
            <div class="product-tabs bg-white rounded shadow-sm">
              <!-- Tab Navigation -->
              <ul class="nav nav-tabs nav-justified" id="productTabs" role="tablist">
                <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="description-tab" data-bs-toggle="tab" data-bs-target="#description" type="button" role="tab" aria-controls="description" aria-selected="true">
                    {t(lang, 'product.description')}
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="specs-tab" data-bs-toggle="tab" data-bs-target="#specs" type="button" role="tab" aria-controls="specs" aria-selected="false">
                    {t(lang, 'product.specifications')}
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="faqs-tab" data-bs-toggle="tab" data-bs-target="#faqs" type="button" role="tab" aria-controls="faqs" aria-selected="false">
                    {t(lang, 'product.faq')}
                    {faqs.length > 0 && <span class="tab-badge">{faqs.length}</span>}
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab" aria-controls="reviews" aria-selected="false">
                    {t(lang, 'product.reviews')}
                    {reviews.length > 0 && <span class="tab-badge tab-badge-reviews">{reviews.length}</span>}
                  </button>
                </li>
              </ul>

              <!-- Tab Content -->
              <div class="tab-content p-4" id="productTabsContent">
                <!-- Description Tab -->
                <div class="tab-pane fade show active" id="description" role="tabpanel" aria-labelledby="description-tab">
                  <div class="product-description">
                    <Content />
                  </div>
                </div>

                <!-- Specifications Tab -->
                <div class="tab-pane fade" id="specs" role="tabpanel" aria-labelledby="specs-tab">
                  <h4 class="mb-4" style="color: #023e8a;">{t(lang, 'product.specifications')}</h4>
                  <table class="table table-striped">
                    <tbody>
                      <tr>
                        <th scope="row" style="width: 40%;">{t(lang, 'product.casNo')}</th>
                        <td>{product.data.cas}</td>
                      </tr>
                      <tr>
                        <th scope="row">{t(lang, 'product.molecularWeight')}</th>
                        <td>{product.data.molecular_weight}</td>
                      </tr>
                      <tr>
                        <th scope="row">{t(lang, 'product.purity')}</th>
                        <td class="text-success font-weight-bold">{product.data.purity}</td>
                      </tr>
                      <tr>
                        <th scope="row">{t(lang, 'product.storage')}</th>
                        <td>{product.data.storage}</td>
                      </tr>
                      <tr>
                        <th scope="row">{t(lang, 'product.availableSizes')}</th>
                        <td>{product.data.package_sizes?.join(', ') || '—'}</td>
                      </tr>
                      <tr>
                        <th scope="row">{t(lang, 'product.priceRangeLabel')}</th>
                        <td class="font-weight-bold" style="color: #0077b6;">{priceRange}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <!-- FAQs Tab -->
                <div class="tab-pane fade" id="faqs" role="tabpanel" aria-labelledby="faqs-tab">
                  <ProductFAQs productName={product.data.title.split('|')[0].trim().replace('Buy ', '').replace(' UK', '')} faqs={faqs} />
                </div>

                <!-- Reviews Tab -->
                <div class="tab-pane fade" id="reviews" role="tabpanel" aria-labelledby="reviews-tab">
                  <ProductReviews productName={product.data.title.split('|')[0].trim().replace('Buy ', '').replace(' UK', '')} reviews={reviews} />
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Right Sidebar - Product Options -->
        <div class="col-lg-4">
          <div class="course-widget border py-4 px-3 mt-5 mt-lg-0 sticky-top bg-white rounded shadow-sm" style="top: 100px;">
            <h3 class="text-center mb-4" style="color: #023e8a;">{t(lang, 'product.selectQuantity')}</h3>
            
            <!-- Product Options Component -->
            <ProductOptions 
              client:load
              id={productId}
              title={productTitle}
              basePrice={product.data.price || productPrice}
              packageSizes={product.data.package_sizes || []}
              moq={product.data.moq}
              image={productImage}
              category={product.data.category}
              lang="en"
            />
            
            <!-- Quick Info -->
            <div class="mt-4 pt-3 border-top">
              <ul class="list-unstyled mb-0">
                <li class="d-flex justify-content-between align-items-center py-2 border-bottom">
                  <span class="text-muted">{t(lang, 'nav.categories')}</span>
                  <a href={`/peptides/${product.data.category}/`} class="text-capitalize" style="color: #0077b6;">
                    {product.data.category.replace(/-/g, ' ')}
                  </a>
                </li>
                <li class="d-flex justify-content-between align-items-center py-2 border-bottom">
                  <span class="text-muted">{t(lang, 'product.purity')}</span>
                  <span class="text-success font-weight-bold">{product.data.purity}</span>
                </li>
                <li class="d-flex justify-content-between align-items-center py-2">
                  <span class="d-flex align-items-center text-muted">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-1 text-success">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    {t(lang, 'product.inStock')}
                  </span>
                  <span class="text-success font-weight-bold">{t(lang, 'product.inStock')}</span>
                </li>
              </ul>
            </div>
            
            {product.data.coa_url && (
              <div class="text-center mt-3">
                <a href={product.data.coa_url} class="btn btn-outline-primary btn-sm w-100 d-flex align-items-center justify-content-center" target="_blank">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" x2="12" y1="15" y2="3"></line>
                  </svg>
                  {t(lang, 'product.downloadCoa')}
                </a>
              </div>
            )}
          </div>
          
          <div class="course-widget py-4 px-3 mt-3 border bg-white rounded shadow-sm">
            <h5 class="mb-3 d-flex align-items-center">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-2" style="color: #0077b6;">
                <path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2"></path>
                <path d="M15 18H9"></path>
                <path d="M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14"></path>
                <circle cx="17" cy="18" r="2"></circle>
                <circle cx="7" cy="18" r="2"></circle>
              </svg>
              {t(lang, 'cart.deliveryOptions')}
            </h5>
            <div class="d-flex justify-content-between mb-2 small">
              <span>{t(lang, 'cart.standardDelivery')} ({t(lang, 'cart.standardDeliveryTime')})</span>
              <strong>£5.99</strong>
            </div>
            <div class="d-flex justify-content-between mb-2 small">
              <span>{t(lang, 'cart.expressDelivery')} ({t(lang, 'cart.expressDeliveryTime')})</span>
              <strong>£12.99</strong>
            </div>
            <div class="d-flex justify-content-between small text-success">
              <span>{t(lang, 'cart.ordersOverThreshold').replace('{amount}', '500')}</span>
              <strong>{t(lang, 'common.free').toUpperCase()}</strong>
            </div>
          </div>

          <div class="course-widget py-4 px-3 mt-3 bg-white rounded shadow-sm">
            <div class="alert alert-warning d-flex align-items-start mb-0">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-2 flex-shrink-0" style="margin-top: 2px;">
                <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path>
                <line x1="12" x2="12" y1="9" y2="13"></line>
                <line x1="12" x2="12.01" y1="17" y2="17"></line>
              </svg>
              <div>
                <strong>{t(lang, 'product.researchOnlyTitle')}:</strong> {t(lang, 'product.researchOnlyText')}
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Related Products Section -->
      <RelatedProducts currentSlug={currentSlug} category={product.data.category} limit={4} lang="en" />
    </div>
  </section>
</Layout>

<style>
  /* Product Hero Section - Compact */
  .product-hero {
    background: linear-gradient(135deg, #023e8a 0%, #0077b6 100%);
    padding: 1.5rem 0 2rem;
    position: relative;
  }
  
  .product-hero .container {
    position: relative;
    z-index: 1;
  }
  
  /* Premium Breadcrumb */
  .premium-breadcrumb {
    margin-bottom: 1rem;
  }
  
  .breadcrumb-list {
    display: flex;
    align-items: center;
    list-style: none;
    padding: 0;
    margin: 0;
    flex-wrap: wrap;
    gap: 0;
  }
  
  .breadcrumb-list .breadcrumb-item {
    display: flex;
    align-items: center;
    font-size: 0.85rem;
  }
  
  .breadcrumb-list .breadcrumb-item a {
    color: white;
    text-decoration: none;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    font-weight: 500;
  }
  
  .breadcrumb-list .breadcrumb-item a:hover {
    color: #ffd700;
  }
  
  .breadcrumb-list .breadcrumb-item a svg {
    opacity: 1;
  }
  
  .breadcrumb-list .breadcrumb-item:not(:last-child)::after {
    content: '';
    display: inline-block;
    width: 6px;
    height: 6px;
    border-right: 1.5px solid white;
    border-top: 1.5px solid white;
    transform: rotate(45deg);
    margin: 0 0.75rem;
  }
  
  .breadcrumb-list .breadcrumb-item.active {
    color: white;
    font-weight: 600;
  }
  
  /* Product Title */
  .product-title {
    font-size: 1.85rem;
    font-weight: 700;
    line-height: 1.2;
    color: white;
    margin: 0 0 0.5rem 0;
  }
  
  /* Product Subtitle */
  .product-subtitle {
    color: rgba(255, 255, 255, 0.85);
    font-size: 1rem;
    margin: 0;
    max-width: 700px;
  }

  /* Tab Styling */
  .nav-tabs {
    border-bottom: 2px solid #e9ecef;
  }
  
  .nav-tabs .nav-link {
    border: none;
    border-bottom: 3px solid transparent;
    color: #6c757d;
    font-weight: 600;
    padding: 1rem 1.5rem;
    transition: all 0.3s ease;
    font-size: 0.95rem;
  }
  
  .nav-tabs .nav-link:hover {
    border-color: transparent;
    color: #0077b6;
    background: transparent;
  }
  
  .nav-tabs .nav-link.active {
    color: #0077b6;
    background: transparent;
    border-bottom: 3px solid #0077b6;
  }
  
  /* Tab Badges */
  .tab-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 20px;
    height: 20px;
    padding: 0 6px;
    margin-left: 6px;
    font-size: 11px;
    font-weight: 600;
    color: white;
    background-color: #0077b6;
    border-radius: 10px;
    vertical-align: middle;
  }
  
  .tab-badge-reviews {
    background-color: #f5a623;
  }
  
  .tab-content {
    min-height: 400px;
  }

  /* Product Description Styling */
  .product-description :global(h1),
  .product-description :global(h2),
  .product-description :global(h3),
  .product-description :global(h4) {
    color: #023e8a;
    margin-top: 1.5rem;
    margin-bottom: 1rem;
  }
  
  .product-description :global(h2) {
    font-size: 1.4rem;
    border-bottom: 2px solid #0077b6;
    padding-bottom: 0.5rem;
  }
  
  .product-description :global(h3) {
    font-size: 1.15rem;
  }
  
  .product-description :global(ul) {
    padding-left: 1.5rem;
  }
  
  .product-description :global(li) {
    margin-bottom: 0.5rem;
  }
  
  .product-description :global(p) {
    line-height: 1.8;
    margin-bottom: 1rem;
  }
  
  .product-description :global(strong) {
    color: #023e8a;
  }

  .product-description :global(table) {
    width: 100%;
    margin: 1rem 0;
  }

  /* Sidebar Styling */
  .sidebar-widget h4 {
    color: #023e8a;
    font-size: 1.1rem;
  }

  .sidebar-widget h5 {
    color: #023e8a;
    font-size: 1rem;
  }

  /* Mobile Adjustments */
  @media (max-width: 991px) {
    .product-title {
      font-size: 1.5rem;
    }
    
    .product-subtitle {
      font-size: 0.9rem;
    }
    
    /* Product image gallery on tablet */
    .col-lg-5.col-md-6 {
      margin-bottom: 24px;
    }
  }
  
  @media (max-width: 767px) {
    .product-hero {
      padding: 1rem 0 1.25rem;
    }
    
    .product-title {
      font-size: 1.25rem;
      line-height: 1.3;
    }
    
    .product-subtitle {
      font-size: 0.85rem;
      margin-bottom: 8px;
    }
    
    .breadcrumb-list .breadcrumb-item {
      font-size: 0.7rem;
    }
    
    .breadcrumb-list .breadcrumb-item:not(:last-child)::after {
      margin: 0 0.4rem;
      width: 5px;
      height: 5px;
    }
    
    .nav-tabs {
      flex-wrap: nowrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 4px;
    }
    
    .nav-tabs .nav-link {
      padding: 0.75rem 0.5rem;
      font-size: 0.8rem;
      white-space: nowrap;
      flex-shrink: 0;
    }
    
    /* Product cards full width stack */
    .section.course {
      padding: 30px 0;
    }
    
    /* Price and buttons */
    .product-main-card {
      padding: 16px !important;
    }
  }
  
  @media (max-width: 575px) {
    .product-hero {
      padding: 0.75rem 0 1rem;
    }
    
    .product-title {
      font-size: 1.1rem;
    }
    
    .premium-breadcrumb {
      margin-bottom: 12px;
    }
    
    .breadcrumb-list .breadcrumb-item {
      font-size: 0.65rem;
    }
    
    /* Only show essential breadcrumb items on mobile */
    .breadcrumb-list .breadcrumb-item:nth-child(3) {
      display: none;
    }
    
    .nav-tabs .nav-link {
      padding: 0.6rem 0.4rem;
      font-size: 0.75rem;
    }
    
    /* Touch-friendly add to cart */
    button[type="submit"],
    .btn-primary,
    .btn-main {
      min-height: 48px;
      font-size: 15px;
    }
    
    /* Tab content padding */
    .tab-content {
      padding: 16px 8px;
    }
  }
  
  /* Touch device optimizations */
  @media (hover: none) and (pointer: coarse) {
    .product-thumbnail:hover,
    .nav-tabs .nav-link:hover {
      transform: none;
    }
  }
</style>

<script>
  // Initialize Bootstrap tabs
  document.addEventListener('DOMContentLoaded', function() {
    const triggerTabList = document.querySelectorAll('#productTabs button');
    triggerTabList.forEach(function(triggerEl) {
      triggerEl.addEventListener('click', function(event: Event) {
        event.preventDefault();
        const clickedTab = event.currentTarget as HTMLElement;
        
        // Remove active from all tabs
        triggerTabList.forEach(tab => {
          tab.classList.remove('active');
          tab.setAttribute('aria-selected', 'false');
        });
        
        // Add active to clicked tab
        clickedTab.classList.add('active');
        clickedTab.setAttribute('aria-selected', 'true');
        
        // Hide all tab panes
        const tabPanes = document.querySelectorAll('.tab-pane');
        tabPanes.forEach(pane => {
          pane.classList.remove('show', 'active');
        });
        
        // Show target pane
        const targetId = clickedTab.getAttribute('data-bs-target');
        if (targetId) {
          const targetPane = document.querySelector(targetId);
          if (targetPane) {
            targetPane.classList.add('show', 'active');
          }
        }
      });
    });
  });
</script>
